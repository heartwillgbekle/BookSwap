<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookSwap | Student Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CORE SPA UTILITIES */
        .screen { display: none !important; }
        .screen.active { display: flex !important; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* BACKGROUND - The Library Shelf Image */
        .bg-library { 
            /* We add a dark gradient overlay so the white text is always readable */
            background: linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.85)), 
            url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?auto=format&fit=crop&q=80&w=2000');
            background-size: cover; 
            background-position: center;
            background-attachment: fixed; /* Keeps the background still while you scroll */
        }

        /* GLASS MORPHISM (Dark Mode Containers) */
        .glass-dark {
            background: rgba(15, 23, 42, 0.85); /* Darker opacity for better contrast */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-slate-900 font-sans text-slate-100 antialiased selection:bg-indigo-500 selection:text-white">
    
    {% csrf_token %}

    <section id="screen-login" class="screen active min-h-screen items-center justify-center p-4 bg-library">
        <div class="glass-dark p-10 rounded-3xl shadow-2xl w-full max-w-md border-t border-white/20 fade-in">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-black text-white mb-2 tracking-tighter">BookSwap<span class="text-indigo-500">.</span></h1>
                <p class="text-slate-300 font-medium">Student Marketplace</p>
            </div>
            <div class="space-y-5">
                <div>
                    <input id="login-user" type="text" placeholder="Username" class="w-full p-4 rounded-xl bg-slate-900/60 border border-slate-600 text-white placeholder-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition">
                </div>
                <div>
                    <input id="login-pass" type="password" placeholder="Password" class="w-full p-4 rounded-xl bg-slate-900/60 border border-slate-600 text-white placeholder-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition">
                </div>
                
                <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition shadow-lg shadow-indigo-900/50 transform hover:-translate-y-1">
                    Log In
                </button>
                
                <div class="text-center pt-4">
                    <p class="text-slate-400 text-sm">Don't have an account?</p>
                    <button onclick="switchView('screen-register')" class="text-indigo-400 hover:text-white font-bold transition mt-1">
                        Create Account
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-register" class="screen min-h-screen items-center justify-center p-4 bg-library">
        <div class="glass-dark p-10 rounded-3xl shadow-2xl w-full max-w-md border-t border-white/20 fade-in">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">Join the Club</h1>
                <p class="text-slate-300">Start trading books today.</p>
            </div>
            <div class="space-y-5">
                <input id="reg-user" type="text" placeholder="Choose Username" class="w-full p-4 rounded-xl bg-slate-900/60 border border-slate-600 text-white placeholder-slate-400 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none transition">
                <input id="reg-pass" type="password" placeholder="Create Password" class="w-full p-4 rounded-xl bg-slate-900/60 border border-slate-600 text-white placeholder-slate-400 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none transition">
                
                <button onclick="register()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl transition shadow-lg shadow-green-900/50 transform hover:-translate-y-1">
                    Create Account
                </button>
                
                <button onclick="switchView('screen-login')" class="w-full text-slate-400 hover:text-white text-sm font-semibold py-2">
                    ‚Üê Back to Login
                </button>
            </div>
        </div>
    </section>

    <section id="screen-dashboard" class="screen flex-col min-h-screen bg-library">
        
        <nav class="glass-dark border-b border-white/5 sticky top-0 z-50 px-6 py-4 flex justify-between items-center shadow-lg">
            <h2 class="text-2xl font-black text-white tracking-tighter">BookSwap<span class="text-indigo-500">.</span></h2>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-sm">
                        <span id="avatar-initial">U</span>
                    </div>
                    <span id="display-username" class="font-bold text-slate-200 hidden md:block">User</span>
                </div>
                <button onclick="logout()" class="text-xs bg-slate-800 border border-slate-700 text-slate-300 px-4 py-2 rounded-lg font-bold hover:bg-red-900/50 hover:text-red-400 hover:border-red-900 transition">
                    Logout
                </button>
            </div>
        </nav>

        <main class="flex-grow container mx-auto px-4 py-8 max-w-6xl">
            
            <div class="glass-dark border border-white/10 rounded-3xl p-8 mb-10 text-white shadow-2xl relative overflow-hidden fade-in">
                <div class="relative z-10">
                    <h2 class="text-3xl font-bold mb-4">Find your next read.</h2>
                    <div class="flex bg-slate-900/80 backdrop-blur rounded-2xl overflow-hidden p-2 border border-indigo-400/30">
                        <input id="book-query" type="text" placeholder="Search by Title, Author, or ISBN..." class="flex-1 px-4 py-3 bg-transparent text-white focus:outline-none placeholder-slate-400">
                        <button onclick="lookup()" class="bg-indigo-500 px-8 py-3 rounded-xl font-bold hover:bg-white hover:text-indigo-600 transition">Search</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-3 space-y-6">
                    <div class="glass-card p-5 rounded-2xl sticky top-24 fade-in">
                        <h3 class="font-bold mb-4 text-slate-400 uppercase text-xs tracking-widest">Marketplace</h3>
                        <div class="space-y-2">
                            <button onclick="loadMarketplace('all')" class="w-full text-left p-3 rounded-xl hover:bg-white/5 font-semibold text-slate-300 hover:text-white transition flex justify-between">
                                <span>üìö Browse All</span>
                            </button>
                            <button onclick="loadMarketplace('mine')" class="w-full text-left p-3 rounded-xl hover:bg-white/5 font-semibold text-slate-300 hover:text-white transition flex justify-between">
                                <span>üë§ My Listings</span>
                            </button>
                        </div>

                        <div class="my-4 border-t border-white/10"></div>

                        <h3 class="font-bold mb-4 text-slate-400 uppercase text-xs tracking-widest">Categories</h3>
                        <div class="space-y-1">
                            <button onclick="filterByCategory('STEM')" class="w-full text-left p-2 rounded-lg hover:bg-white/5 text-sm text-slate-400 hover:text-indigo-400 transition">üî¨ Science & Tech</button>
                            <button onclick="filterByCategory('BIZ')" class="w-full text-left p-2 rounded-lg hover:bg-white/5 text-sm text-slate-400 hover:text-indigo-400 transition">üìà Business</button>
                            <button onclick="filterByCategory('HUM')" class="w-full text-left p-2 rounded-lg hover:bg-white/5 text-sm text-slate-400 hover:text-indigo-400 transition">üìö Humanities</button>
                            <button onclick="filterByCategory('ART')" class="w-full text-left p-2 rounded-lg hover:bg-white/5 text-sm text-slate-400 hover:text-indigo-400 transition">üé® Arts</button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-9">
                    
                    <div id="searchResult" class="hidden glass-dark p-6 rounded-3xl mb-10 border border-indigo-500/30 shadow-lg shadow-indigo-500/10 fade-in">
                        <div class="flex flex-col md:flex-row gap-6 items-start">
                            <img id="resImg" src="" class="w-32 h-48 object-cover rounded-xl shadow-lg border border-white/10">
                            <div class="flex-1 w-full">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 id="resTitle" class="text-2xl font-bold text-white"></h3>
                                        <p id="resAuthor" class="text-slate-400 mb-4"></p>
                                    </div>
                                    <button onclick="document.getElementById('searchResult').classList.add('hidden')" class="text-slate-500 hover:text-white">‚úï</button>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">PRICE ($)</label>
                                        <input id="listPrice" type="number" step="0.01" class="w-full p-3 bg-slate-900/60 rounded-xl border border-slate-600 text-white focus:border-indigo-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">CONDITION</label>
                                        <select id="listCondition" class="w-full p-3 bg-slate-900/60 rounded-xl border border-slate-600 text-white focus:border-indigo-500 focus:outline-none">
                                            <option value="GOOD">Good</option>
                                            <option value="NEW">Like New</option>
                                            <option value="POOR">Heavily Used</option>
                                        </select>
                                    </div>
                                </div>
                                <button onclick="saveListing()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold transition">Confirm Listing</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mb-6 fade-in">
                        <h2 id="feed-title" class="text-2xl font-bold text-white shadow-black drop-shadow-md">Latest Listings</h2>
                    </div>

                    <div id="marketplace" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                </div>
            </div>
        </main>
    </section>

    <script>
        const baseUrl = window.location.origin; 
        let authToken = localStorage.getItem('token');
        let currentBook = {};
        let allBooks = [];

        function switchView(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(screenId);
            if(target) target.classList.add('active');
            window.scrollTo(0, 0);
        }

        function checkSession() {
            if (authToken) {
                switchView('screen-dashboard');
                loadMarketplace();
                const user = localStorage.getItem('username');
                if(user) {
                    document.getElementById('display-username').innerText = user;
                    document.getElementById('avatar-initial').innerText = user.charAt(0).toUpperCase();
                }
            } else {
                switchView('screen-login');
            }
        }

        function getCSRF() { return document.querySelector('[name=csrfmiddlewaretoken]')?.value || ""; }

        async function login() {
            const username = document.getElementById('login-user').value;
            const password = document.getElementById('login-pass').value;
            try {
                const res = await fetch(`${baseUrl}/api/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.token) {
                    authToken = data.token;
                    localStorage.setItem('token', authToken);
                    localStorage.setItem('username', username);
                    checkSession();
                } else { alert("Login Failed"); }
            } catch (err) { alert("Server error"); }
        }

        async function register() {
            const username = document.getElementById('reg-user').value;
            const password = document.getElementById('reg-pass').value;
            try {
                const res = await fetch(`${baseUrl}/api/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
                    body: JSON.stringify({ username, password })
                });
                if (res.ok) { alert("Account Created!"); switchView('screen-login'); }
                else { alert("Error creating account"); }
            } catch (err) { alert("Registration failed"); }
        }

        function logout() { localStorage.clear(); location.reload(); }

        async function lookup() {
            const query = document.getElementById('book-query').value.trim();
            if(!query) return;
            try {
                const isIsbn = /^\d+$/.test(query.replace(/-/g, ""));
                const endpoint = isIsbn ? `isbn=${query}` : `q=${encodeURIComponent(query)}`;
                const res = await fetch(`${baseUrl}/api/books/lookup/?${endpoint}`);
                if (!res.ok) throw new Error("Not found");
                const data = await res.json();
                currentBook = data;
                const form = document.getElementById('searchResult');
                form.classList.remove('hidden');
                document.getElementById('resTitle').innerText = data.title;
                document.getElementById('resAuthor').innerText = data.author;
                document.getElementById('resImg').src = data.cover_image_url ? data.cover_image_url.replace('http:', 'https:') : '';
            } catch (err) { alert("Book not found."); }
        }

        async function saveListing() {
            if(!authToken) return alert("Log in first.");
            try {
                const res = await fetch(`${baseUrl}/api/listings/create/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${authToken}`, 'X-CSRFToken': getCSRF() },
                    body: JSON.stringify({
                        title: currentBook.title,
                        author: currentBook.author,
                        isbn: currentBook.isbn || "0",
                        condition: document.getElementById('listCondition').value,
                        category: "GEN",
                        price: document.getElementById('listPrice').value,
                        cover_image_url: currentBook.cover_image_url
                    })
                });
                if(res.ok) {
                    alert("Listed!");
                    document.getElementById('searchResult').classList.add('hidden');
                    document.getElementById('book-query').value = "";
                    loadMarketplace();
                }
            } catch(err) { console.error(err); }
        }

        async function loadMarketplace(filter = 'all') {
            try {
                const res = await fetch(`${baseUrl}/api/listings/`);
                allBooks = await res.json();
                let displayBooks = allBooks;
                if (filter === 'mine') {
                    const currentUser = localStorage.getItem('username');
                    displayBooks = allBooks.filter(b => b.seller === currentUser);
                    document.getElementById('feed-title').innerText = "My Listings";
                } else {
                    document.getElementById('feed-title').innerText = "Latest Listings";
                }
                renderBooks(displayBooks);
            } catch (err) { console.error(err); }
        }

        function filterByCategory(cat) {
            const filtered = allBooks.filter(b => b.category === cat);
            document.getElementById('feed-title').innerText = cat + " Books";
            renderBooks(filtered);
        }

        function renderBooks(books) {
            const container = document.getElementById('marketplace');
            if (books.length === 0) {
                container.innerHTML = `<div class="p-10 text-center text-slate-300 font-bold bg-slate-900/50 rounded-xl border border-slate-700 col-span-2">No listings found.</div>`;
                return;
            }
            const currentUser = localStorage.getItem('username');
            
            container.innerHTML = books.map(book => `
                <div class="glass-card p-4 rounded-2xl flex gap-4 hover:bg-slate-800 transition group border border-transparent hover:border-indigo-500/30 shadow-lg">
                    <img src="${book.cover_image_url ? book.cover_image_url.replace('http:', 'https:') : ''}" class="w-20 h-28 object-cover rounded-lg shadow-md bg-slate-700">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-slate-100 line-clamp-1">${book.title}</h4>
                            <span class="bg-indigo-900/50 text-indigo-300 border border-indigo-500/30 text-xs font-bold px-2 py-1 rounded-md">$${book.price}</span>
                        </div>
                        <p class="text-xs text-slate-400 mb-2">${book.author}</p>
                        <div class="flex justify-between items-end mt-2">
                            <span class="text-[10px] uppercase tracking-wider font-bold text-slate-500 bg-slate-900 px-2 py-1 rounded border border-slate-700">${book.condition}</span>
                            
                            ${book.seller === currentUser ? 
                                `<button onclick="deleteListing(${book.id})" class="text-xs text-red-400 hover:text-red-300 font-bold bg-red-900/20 px-2 py-1 rounded">Delete</button>` : 
                                `<a href="mailto:${book.seller_email}" class="text-xs bg-slate-700 text-slate-200 px-3 py-2 rounded-lg hover:bg-white hover:text-black transition font-semibold">Contact</a>`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function deleteListing(id) {
            if(!confirm("Remove listing?")) return;
            await fetch(`${baseUrl}/api/listings/delete/${id}/`, {
                method: 'DELETE',
                headers: { 'Authorization': `Token ${authToken}`, 'X-CSRFToken': getCSRF() }
            });
            loadMarketplace('mine');
        }

        checkSession();
    </script>
</body>
</html>
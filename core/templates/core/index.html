<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>BookSwap | Student Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .hero-bg { 
            background: linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.7)), 
            url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?auto=format&fit=crop&q=80&w=2000');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    {% csrf_token %}

    <header class="hero-bg min-h-[60vh] flex flex-col items-center justify-center text-white px-4 text-center">
        <h1 class="text-5xl font-extrabold mb-4 tracking-tight">Swap Books, Save Money.</h1>
        <p class="text-xl text-slate-200 mb-8 max-w-2xl">The exclusive marketplace for students to trade textbooks and learning materials.</p>
        
        <div class="w-full max-w-xl">
            <div class="flex bg-white rounded-full overflow-hidden shadow-2xl">
                <input id="isbn" type="text" placeholder="Search by ISBN..." class="flex-1 px-6 py-4 text-slate-800 focus:outline-none">
                <button onclick="lookup()" class="bg-indigo-600 px-8 py-4 font-bold hover:bg-indigo-700 transition">Search</button>
            </div>
            <p id="isbnError" class="text-red-300 text-sm mt-2 ml-6 hidden font-semibold"></p>
        </div>
    </header>

    <main class="container mx-auto -mt-16 px-4 pb-20">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="glass p-6 rounded-2xl shadow-xl border border-white">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span id="statusDot" class="w-3 h-3 bg-slate-300 rounded-full transition-colors duration-500"></span> 
                        Account
                    </h2>
                    <div id="authForms">
                        <input id="user" type="text" placeholder="Username" class="w-full mb-3 p-3 bg-slate-100 rounded-lg focus:ring-2 ring-indigo-500 outline-none border-none">
                        <input id="pass" type="password" placeholder="Password" class="w-full mb-4 p-3 bg-slate-100 rounded-lg focus:ring-2 ring-indigo-500 outline-none border-none">
                        <button onclick="login()" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold mb-2 hover:bg-slate-800 transition">Login</button>
                        <button onclick="register()" class="w-full text-indigo-600 font-semibold py-2">Create Account</button>
                    </div>
                    <div id="userInfo" class="hidden text-center py-4">
                        <p class="text-slate-500 text-sm">Logged in as</p>
                        <p class="font-bold text-xl text-indigo-600 mb-6" id="usernameDisplay"></p>
                        <button onclick="location.reload()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-200">Logout</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div id="searchResult" class="hidden glass p-6 rounded-2xl shadow-xl border-2 border-dashed border-indigo-200 mb-8 flex gap-6 items-center">
                    <img id="resImg" src="" class="w-32 h-44 object-cover rounded-lg shadow-lg bg-gray-200">
                    <div class="flex-1">
                        <h3 id="resTitle" class="text-2xl font-bold text-slate-800"></h3>
                        <p id="resAuthor" class="text-slate-500 mb-6"></p>
                        
                        <div class="flex gap-4 mb-6">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Price ($)</label>
                                <input id="listPrice" type="number" step="0.01" placeholder="0.00" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 ring-indigo-500 outline-none">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Condition</label>
                                <select id="listCondition" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200 focus:ring-2 ring-indigo-500 outline-none">
                                    <option value="NEW">New</option>
                                    <option value="LIKE_NEW">Like New</option>
                                    <option value="GOOD" selected>Good</option>
                                    <option value="FAIR">Fair</option>
                                    <option value="POOR">Poor</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="saveListing()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-100 transition transform hover:-translate-y-1">Confirm & Post Listing</button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold">Latest Listings</h2>
                    
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </span>
                        <input id="marketSearch" onkeyup="filterBooks()" type="text" placeholder="Search title or author..." 
                            class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 ring-indigo-500 outline-none shadow-sm">
                    </div>
                </div>

                <div id="marketplace" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
            </div>
        </div>
    </main>

    <script>
        const baseUrl = window.location.origin; 
        let authToken = "";
        let currentBook = {};
        let allBooks = [];

        // Helper: Convert insecure URLs to secure HTTPS
        function secureUrl(url) {
            if (!url || typeof url !== 'string') {
                return 'https://via.placeholder.com/150/e2e8f0/64748b?text=No+Cover';
            }
            return url.trim().replace('http://', 'https://');
        }

        function getCSRF() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            return token ? token.value : "";
        }

        const val = (id) => document.getElementById(id).value;

        // AUTHENTICATION
        async function register() {
            const res = await fetch(`${baseUrl}/api/register/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
                body: JSON.stringify({username: val('user'), password: val('pass')})
            });
            if(res.ok) alert("Welcome! Your account is ready. Please log in.");
            else alert("Error: Use a unique username.");
        }

        async function login() {
            const res = await fetch(`${baseUrl}/api/login/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
                body: JSON.stringify({username: val('user'), password: val('pass')})
            });
            const data = await res.json();
            if(data.token) {
                authToken = data.token;
                document.getElementById('authForms').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('usernameDisplay').innerText = val('user');
                document.getElementById('statusDot').classList.replace('bg-slate-300', 'bg-green-500');
                loadMarketplace();
            } else {
                alert("Login failed.");
            }
        }

        // IMPROVED BOOK LOOKUP
        async function lookup() {
            const isbnInput = val('isbn');
            const cleanIsbn = isbnInput.replace(/[^0-9]/g, ""); // Remove dashes/spaces
            const errorEl = document.getElementById('isbnError');
            
            errorEl.classList.add('hidden');

            if(!cleanIsbn) return alert("Please enter an ISBN first.");
            
            if(cleanIsbn.length > 13) {
                errorEl.innerText = "ISBN too long (Max 13 digits)";
                errorEl.classList.remove('hidden');
                return;
            }
            
            const searchBtn = document.querySelector('button[onclick="lookup()"]');
            searchBtn.innerText = "Searching...";

            try {
                const res = await fetch(`${baseUrl}/api/books/lookup/?isbn=${cleanIsbn}`);
                if(!res.ok) throw new Error("Book not found.");
                
                const data = await res.json();
                currentBook = {
                    ...data,
                    cover_image_url: secureUrl(data.cover_image_url) 
                };

                document.getElementById('searchResult').classList.remove('hidden');
                document.getElementById('resTitle').innerText = currentBook.title;
                document.getElementById('resAuthor').innerText = currentBook.author;
                document.getElementById('resImg').src = currentBook.cover_image_url;
                window.scrollTo({ top: 400, behavior: 'smooth' });
            } catch (err) {
                alert("We couldn't find that ISBN. Check the number on the back of the book.");
            } finally {
                searchBtn.innerText = "Search";
            }
        }

        // SAVE LISTING
        async function saveListing() {
            if(!authToken) return alert("Please login first to list a book!");
            
            // Format price to 2 decimal places (e.g., "12.50")
            const priceInput = val('listPrice') || "0.00";
            const formattedPrice = parseFloat(priceInput).toFixed(2);
            
            const cleanIsbn = val('isbn').replace(/[^0-9]/g, "");

            const res = await fetch(`${baseUrl}/api/listings/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${authToken}`,
                    'X-CSRFToken': getCSRF()
                },
                body: JSON.stringify({
                    title: currentBook.title,
                    author: currentBook.author,
                    isbn: cleanIsbn,
                    condition: document.getElementById('listCondition').value,
                    price: formattedPrice,
                    cover_image_url: currentBook.cover_image_url
                })
            });
            
            if(res.ok) {
                alert(`Success! Listed for $${formattedPrice}`);
                document.getElementById('searchResult').classList.add('hidden');
                loadMarketplace();
            } else {
                const errorData = await res.json();
                console.log("Server Error:", errorData);
                // Map server errors to a readable alert
                let msg = Object.entries(errorData).map(([k, v]) => `${k}: ${v}`).join("\n");
                alert("Save failed:\n" + msg);
            }
        }

        // LOAD MARKETPLACE
        async function loadMarketplace() {
            try {
                const res = await fetch(`${baseUrl}/api/listings/`);
                // Store the data globally so we can filter it without re-fetching
                allBooks = await res.json(); 
                // Render the full list initially
                renderMarketplace(allBooks); 
            } catch (err) {
                console.error("Failed to load marketplace:", err);
                document.getElementById('marketplace').innerHTML = `<p class="col-span-2 text-center py-10 text-red-400">Error loading feed.</p>`;
            }
        }

        
        function filterBooks() {
            const query = val('marketSearch').toLowerCase();
            
            const filtered = allBooks.filter(book => 
                book.title.toLowerCase().includes(query) || 
                book.author.toLowerCase().includes(query)
            );
            
            renderMarketplace(filtered);
        }

        // NEW: Helper function to draw the cards (to avoid repeating code)
        function renderMarketplace(books) {
            const container = document.getElementById('marketplace');
            
            if (books.length === 0) {
                container.innerHTML = `<p class="col-span-2 text-center py-10 text-slate-400">No books match your search.</p>`;
                return;
            }

            container.innerHTML = books.map(book => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex gap-5 items-center hover:shadow-xl hover:border-indigo-100 transition-all group">
                    <div class="relative flex-shrink-0">
                        <img src="${secureUrl(book.cover_image_url)}" 
                            onerror="this.src='https://via.placeholder.com/150/e2e8f0/64748b?text=Error'"
                            class="w-24 h-32 object-cover rounded-xl shadow-md bg-slate-50 transition-transform group-hover:scale-105">
                        <div class="absolute -top-2 -right-2 bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded-lg shadow-lg">
                            $${book.price}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-slate-800 leading-tight mb-1 truncate">${book.title}</h4>
                        <p class="text-sm text-slate-400 mb-2 italic truncate">${book.author}</p>
                        
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-5 h-5 bg-indigo-100 rounded-full flex items-center justify-center">
                                <span class="text-[10px] font-bold text-indigo-600">${book.seller ? book.seller[0].toUpperCase() : 'U'}</span>
                            </div>
                            <span class="text-xs text-slate-500 font-medium">${book.seller}</span>
                        </div>

                        <div class="flex justify-between items-center gap-2">
                            <a href="mailto:${book.seller_email}?subject=Interested in ${book.title}" 
                            class="flex-1 bg-slate-900 text-white text-center py-2 rounded-lg text-xs font-bold hover:bg-indigo-600 transition-colors">
                                Contact Seller
                            </a>
                            
                            ${book.seller === val('user') ? `
                                <button onclick="deleteBook(${book.id})" class="text-slate-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }


        async function deleteBook(id) {
            if(!authToken) return alert("Login first.");
            if(!confirm("Remove listing?")) return;
            const res = await fetch(`${baseUrl}/api/listings/delete/${id}/`, {
                method: 'DELETE',
                headers: { 'Authorization': `Token ${authToken}`, 'X-CSRFToken': getCSRF() }
            });
            if(res.ok) loadMarketplace();
            else alert("You can only delete your own listings.");
        }

        loadMarketplace();
    </script>
</body>
</html>
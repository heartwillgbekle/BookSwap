<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookSwap | Student Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-indigo-600 p-4 text-white shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight">BookSwap ðŸ“š</h1>
            <div id="authStatus" class="text-sm font-medium bg-indigo-500 px-3 py-1 rounded">Status: Guest</div>
        </div>
    </nav>

    <div class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">Account</h2>
                <input id="user" type="text" placeholder="Username" class="w-full mb-2 p-2 border rounded">
                <input id="pass" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded">
                <div class="flex gap-2">
                    <button onclick="login()" class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">Login</button>
                    <button onclick="register()" class="flex-1 border border-indigo-600 text-indigo-600 py-2 rounded hover:bg-indigo-50 transition">Sign Up</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">List a New Book</h2>
                <div class="flex gap-2">
                    <input id="isbn" type="text" placeholder="Enter ISBN (e.g. 978...)" class="flex-1 p-2 border rounded">
                    <button onclick="lookup()" class="bg-green-500 text-white px-4 rounded hover:bg-green-600">Search</button>
                </div>
                
                <div id="searchResult" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border-dashed border-2 border-gray-200 text-center">
                    <img id="resImg" src="" class="w-24 h-32 mx-auto mb-2 shadow-md object-cover rounded">
                    <h3 id="resTitle" class="font-bold text-gray-800"></h3>
                    <p id="resAuthor" class="text-sm text-gray-600 mb-3"></p>
                    <button onclick="saveListing()" class="w-full bg-indigo-600 text-white py-2 rounded font-medium">Post to Marketplace</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Live Marketplace</h2>
                <button onclick="loadMarketplace()" class="text-indigo-600 hover:text-indigo-800 font-medium">â†» Refresh Feed</button>
            </div>
            <div id="marketplace" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>
    </div>

<script>
    let authToken = "";
    let currentBook = {};
    const baseUrl = "https://seashell-app-t7cwg.ondigitalocean.app";

    async function register() {
        const res = await fetch(`${baseUrl}/api/register/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: val('user'), password: val('pass')})
        });
        if(res.ok) alert("Account created! Now you can Login.");
        else alert("Registration failed. Try a different username.");
    }

    async function login() {
        const res = await fetch(`${baseUrl}/api/login/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: val('user'), password: val('pass')})
        });
        const data = await res.json();
        if(data.token) {
            authToken = data.token;
            document.getElementById('authStatus').innerText = `User: ${val('user')}`;
            document.getElementById('authStatus').classList.replace('bg-indigo-500', 'bg-green-500');
            loadMarketplace();
        } else alert("Invalid credentials");
    }

    async function lookup() {
        const res = await fetch(`${baseUrl}/api/books/lookup/?isbn=${val('isbn')}`);
        currentBook = await res.json();
        document.getElementById('searchResult').classList.remove('hidden');
        document.getElementById('resTitle').innerText = currentBook.title;
        document.getElementById('resAuthor').innerText = currentBook.author;
        document.getElementById('resImg').src = currentBook.cover_image_url;
    }

    async function saveListing() {
        const res = await fetch(`${baseUrl}/api/listings/create/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Token ${authToken}`},
            body: JSON.stringify({
                title: currentBook.title, author: currentBook.author, isbn: val('isbn'),
                condition: "GOOD", price: "0.00", cover_image_url: currentBook.cover_image_url
            })
        });
        if(res.ok) { alert("Listed!"); loadMarketplace(); }
        else alert("Failed. Check if you are logged in or if book is already listed.");
    }

    async function loadMarketplace() {
        const res = await fetch(`${baseUrl}/api/listings/`);
        const books = await res.json();
        const container = document.getElementById('marketplace');
        container.innerHTML = books.map(book => `
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-4 items-center">
                <img src="${book.cover_image_url}" class="w-16 h-24 object-cover rounded shadow-sm">
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800 leading-tight">${book.title}</h4>
                    <p class="text-xs text-gray-500 mb-2">${book.author}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold bg-gray-100 px-2 py-1 rounded text-gray-600">${book.condition}</span>
                        <button onclick="deleteBook(${book.id})" class="text-red-400 hover:text-red-600 text-xs">Delete</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function deleteBook(id) {
        if(!confirm("Are you sure?")) return;
        const res = await fetch(`${baseUrl}/api/listings/delete/${id}/`, {
            method: 'DELETE',
            headers: {'Authorization': `Token ${authToken}`}
        });
        if(res.ok) loadMarketplace();
        else alert("You can only delete your own books!");
    }

    function val(id) { return document.getElementById(id).value; }
    loadMarketplace(); // Load books on startup
</script>
</body>
</html>
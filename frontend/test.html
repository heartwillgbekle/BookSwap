<!DOCTYPE html>
<html>
<head>
    <title>BookSwap Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 40px; background: #f4f7f6; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        input { width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button.save { background: #3498db; margin-top: 10px; }
        #bookResult { margin-top: 20px; display: none; border-top: 1px solid #eee; padding-top: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h2>1. Login</h2>
    <input type="text" id="user" placeholder="Username">
    <input type="password" id="pass" placeholder="Password">
    <button onclick="login()">Get Access Token</button>
    <p id="tokenStatus">Status: Not logged in</p>

    <hr>

    <h2>2. Search & Save</h2>
    <input type="text" id="isbn" placeholder="Enter ISBN">
    <button onclick="lookup()">Search</button>

    <hr>

    <h2>3. Global Marketplace</h2>
    <button onclick="loadMarketplace()" style="background: #9b59b6;">Refresh Listings</button>
    <div id="marketplaceList" style="margin-top: 20px;"></div>

    <div id="bookResult">
        <h3 id="dispTitle"></h3>
        <p id="dispAuthor"></p>
        <button class="save" onclick="saveListing()">Save to My Listings</button>
    </div>
</div>

<script>
    let authToken = "";
    let currentBook = {};
    const baseUrl = "https://seashell-app-t7cwg.ondigitalocean.app";

    async function login() {
        const res = await fetch(`${baseUrl}/api/login/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: id('user').value, password: id('pass').value})
        });
        const data = await res.json();
        if(data.token) {
            authToken = data.token;
            id('tokenStatus').innerText = "Status: Connected!";
            id('tokenStatus').style.color = "green";
        } else { alert("Login failed"); }
    }

    async function lookup() {
        const res = await fetch(`${baseUrl}/api/books/lookup/?isbn=${id('isbn').value}`);
        currentBook = await res.json();
        id('bookResult').style.display = 'block';
        id('dispTitle').innerText = currentBook.title;
        id('dispAuthor').innerText = currentBook.author;
    }

    async function saveListing() {
        const res = await fetch(`${baseUrl}/api/listings/create/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Token ${authToken}` // The "Key" we got from login
            },
            body: JSON.stringify({
                title: currentBook.title,
                author: currentBook.author,
                isbn: document.getElementById('isbn').value,
                condition: "GOOD",  
                price: "0.00",
                cover_image_url: currentBook.cover_image_url || "" // Adding this since your model requires it
            })
        });
        if(res.ok) { alert("Book Saved Successfully!"); }
        else { alert("Error saving book. Are you logged in?"); }
    }

    async function loadMarketplace() {
        const res = await fetch(`${baseUrl}/api/listings/`);
        const books = await res.json();
        const listDiv = document.getElementById('marketplaceList');
        
        // Clear the current list
        listDiv.innerHTML = "";

        // Loop through the books and create small cards for them
        books.forEach(book => {
            const item = document.createElement('div');
            // Added a flexbox style for a "row" look
            item.style = "display: flex; gap: 15px; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; background: #fff; align-items: center;";
            
            item.innerHTML = `
                <img src="${book.cover_image_url}" style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px; background: #eee;">
                <div>
                    <strong style="font-size: 1.1em;">${book.title}</strong><br>
                    <span style="color: #666;">by ${book.author}</span><br>
                    <small style="background: #e1f5fe; padding: 2px 6px; border-radius: 4px; color: #0288d1;">${book.condition}</small>
                    <strong style="margin-left: 10px; color: #2e7d32;">$${book.price}</strong>
                </div>
            `;
            listDiv.appendChild(item);
        });
    }

    function id(name) { return document.getElementById(name); }
</script>
</body>
</html>